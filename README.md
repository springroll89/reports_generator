# 报告生成器（Report Generator）




## **更新历史**

### **2025-07-29**

- **温度数据扩展**

  - **温度通道扩展**：将温度数据采集从3路（CH1-CH3）扩展到6路（CH1-CH6），全面监测氧烛反应过程中的温度分布。

    > **温度通道定义**：
    >
    > - CH1：外壳上部温度（接近点火端）
    > - CH2：外壳中部温度
    > - CH3：外壳下部温度
    > - CH4：隔热垫外上部温度
    > - CH5：隔热垫外中部温度
    > - CH6：供氧口外温度

    > **数据要求**：温度CSV文件必须包含所有6个通道（CH1-CH6列），采样频率保持2秒不变，程序会自动插值到0.5秒以匹配流量数据。

- **2P/4P模式判断逻辑升级**

  - 更灵活的传感器组合支持：改进了工作模式的自动识别逻辑，支持任意传感器组合。

    > **新判断规则**：
    >
    > - 4个传感器都有数据 → 4P模式
    > - 恰好2个传感器有数据 → 2P模式（使用实际有数据的2个传感器）
    > - 3个传感器有数据 → 警告非标准配置，但继续使用3个传感器分析
    > - 1个传感器有数据 → 警告数据异常，但继续分析

    > **改进效果**：
    >
    > - 支持1&3、1&4、2&3、2&4等任意2传感器组合
    > - 自动识别并使用实际工作的传感器
    > - 避免了原逻辑中忽略有效数据的问题
    > - 计算更准确，不会因为包含无数据传感器而导致平均值失真

- **点火测试记录数据增强**

  - **新增温度监测列**：在原有6列数据基础上，新增3列温度数据（H、I、J列）：

    - 外壳最高温度(°C)：取CH1通道的最大值
    - 隔热垫外最高温度(°C)：取CH4通道的最大值
    - 供氧口最高温度(°C)：取CH6通道的最大值

    > **显示位置**：温度数据显示在总计行，为整个反应过程的最高温度值，便于快速评估热安全性。

- **流量-温度综合分析优化**

  - **图表显示改进**：

    - 扩展为显示6路温度曲线，全面展示温度分布
    - 使用简化的图例名称（外壳上、外壳中、外壳下、隔热垫上、隔热垫中、供氧口）

  - **配色方案优化**：采用高区分度的专业配色方案

    - 平均流量：黑色（原蓝色，避免与CH6混淆）
    - CH1（外壳上）：深红色 `#CC0000`
    - CH2（外壳中）：橙色 `#FF6600`
    - CH3（外壳下）：金黄色 `#FFB300`
    - CH4（隔热垫上）：深绿色 `#009900`
    - CH5（隔热垫中）：紫色 `#9900CC`
    - CH6（供氧口）：深蓝色 `#0066CC`

    > **设计理念**：色相差异大，避免相近色混淆；考虑色盲友好性；专业美观，饱和度适中。

- **向后兼容性**

  - 所有其他功能保持不变，包括数据清洗、平稳性分析、异常分析等
  - 代码结构优化，提高可维护性
  - 如仍使用3路温度数据，程序会自动识别并报错提示

### **2025-07-11**

- **关键点分析优化**

  - **关键时间点调整**：根据新的测试需求，更新了关键点分析的时间节点，从原来的5个时间点扩展到8个时间点。

    > **原时间点**：60、100、142、360、1200秒
    
    > **新时间点**：10、80、150、360、420、1200、1248、1320秒
    
    > **优化说明**：
    > - 新增早期观察点（10秒），更好地捕捉反应初始阶段特征
    > - 调整中期观察点（80、150秒），提供更均匀的时间分布
    > - 保留关键节点（360、420秒），维持与其他分析的一致性
    > - 新增末期观察点（1248、1320秒），更精确地监测反应结束阶段
    
  - **数据完整性保证**：程序自动跳过超出实际反应时间的关键点，确保分析的有效性。例如，若反应在1250秒结束，则1320秒的关键点将被自动忽略。

  - **向后兼容性**：此更新不影响其他分析模块，所有现有功能（性能指标分析、平稳性分析、异常分析等）保持不变。
  
  

### **2025-07-07**

- **重要修复**

  - **累积流量计算方法统一化**：修正了原始数据sheet中"累积总流量L"与点火测试记录数据sheet中"总累积供氧(升)"数值不一致的问题。

    > **问题原因**：两处使用了不同的积分方法——原始数据使用矩形法（`np.cumsum`），点火测试使用梯形积分法（`trapezoid`），导致计算结果存在差异。

    > **解决方案**：统一采用梯形积分法计算累积流量。修改`calculate_cumulative_flow`函数，使用`scipy.integrate.trapezoid`进行数值积分，考虑相邻数据点之间的线性变化，提高计算精度。

    > **技术改进**：
    > - 原方法：`cumulative = np.cumsum(total_flow.values * 0.5 / 60)` （假设每0.5秒内流量恒定）
    > - 新方法：`cumulative[i] = trapezoid(total_flow.values[:i+1], df['时间(s)'].values[:i+1]) / 60` （考虑流量的线性变化）
    > - 梯形积分法在流量变化较大时精度更高，特别是在启动和停止阶段
    
  - 更正了基准曲线不正确的错误，请从项目仓库下载最新的 **.基准曲线 1.csv** 文件，替换掉reports_input文件夹内错误的同名文件。

- **数据一致性保证**

  - 修复后，Excel报告中各处涉及累积流量的数值将保持一致，包括：
    - 原始数据sheet的"累积总流量L"列
    - 点火测试记录数据的"总累积供氧(升)"
    - 平稳性分析中的累积流量相关指标
    - 异常分析表中的累积流量数据
    
    

### **2025-07-03**

- 重要修复

  - 反应时间定义逻辑统一化：修正了程序中多处不一致的反应起止时间定义。现在全局统一采用以下逻辑：

    - 反应开始时间：固定为0秒（数据采集开始时刻）
    - 反应结束时间：平均流量最后一次大于0的时刻
    - 产氧时间：反应结束时间 - 反应开始时间

    > **技术实现**：在数据处理流程早期（第6.5节）即定义全局变量`REACTION_START_TIME`、`REACTION_END_TIME`和`REACTION_DURATION`，确保所有分析模块使用相同的时间定义，避免了之前各模块独立计算导致的不一致问题。

  - 数据自动截断功能：新增智能数据截断机制，自动识别并删除反应结束后的无效数据（流量为0的尾部数据）。

    > **应用场景**：解决了记录仪未及时关闭导致的大量无效零值数据问题，避免图表X轴过长影响可读性。程序会自动报告截断信息，如"删除了1200个无效数据点"。

- 图表优化

  - X轴动态适配：所有图表（流量曲线图、平稳性分析图、流量-温度综合分析图、产氧-深度曲线）的X轴范围自动适配实际反应时长，不再显示反应结束后的空白区域。

    > **优化效果**：X轴最大值统一设置为`REACTION_END_TIME`，主刻度间隔动态计算为`max(100, int(REACTION_END_TIME/10))`，确保不同反应时长的数据都能以合适的比例显示。

  - **关键点分析优化**：关键时间点分析自动跳过超出反应时间范围的时间点，避免无效分析。

- 架构改进

  - **代码可维护性提升**：删除了冗余的`find_reaction_end_time`函数，将反应时间定义集中管理，减少了代码重复和潜在的逻辑冲突。
  - **跨平台一致性**：所有修改同步应用到Mac版本和跨平台版本，确保功能一致性。



### **2025-07-02**

- **新增功能**

  - **点火测试记录数据**：新增专门的点火测试分析表，为点火测试记录提供便捷数据。包含供氧启动时长、达峰时长、峰值维持时长（达峰到流量降至3.1L/min）、从启动到峰值结束供氧总量、反应总时长、总累积供氧等6项关键指标。数据展示各传感器独立值、平均值及所有传感器总计。

  - **平稳性分析**：新增高级稳定性分析功能，全面评估反应过程的流量稳定性。自动识别平稳期（总产氧量达20L到反应结束前120秒），进行线性拟合分析，计算相对基准线变异系数、最大偏差幅度、超调时间占比等多维度指标。配备60秒窗口滑动分析和分段着色的流量曲线全程分析图。

    > **技术特点**：采用scipy.stats线性回归确保统计准确性，稳定性评价分为优秀（CV<5%）、良好（5%≤CV<10%）、一般（10%≤CV<15%）、较差（CV≥15%）四级。图表采用创新的分段着色技术，灰色显示非平稳期，彩色突出平稳期，拟合直线叠加显示。

- **数据增强**

  - 原始数据表新增"累积总流量L"列：基于所有活跃传感器的实时累积流量，为平稳性分析提供基础数据。该数据自动适配2P/4P模式。

- **报表优化**

  - **综合异常分析**：将原本分散的"异常分析_1号"、"异常分析_2号"、"异常分析_3号"、"异常分析_4号"、"异常分析_平均值"等5个Sheet合并为一个"综合异常分析"Sheet。采用分组显示方式，每个传感器的异常数据用标题分隔，便于对比查看。

    > **优化效果**：减少Sheet数量，相关数据集中展示，提高报告的可读性和专业性。

  - **燃烧定位分析**：将原本的"燃烧定位表"和"燃烧定位数据"两个Sheet合并为一个"燃烧定位分析"Sheet。上部显示关键时间点（0、60、120...1200秒）的燃烧定位，下部显示每10秒采样的详细数据（最多30行），超出部分自动添加说明。

    > **设计理念**：既保留了关键数据的快速查看，又提供了详细数据的查询功能，避免数据过多造成的视觉混乱。

- **架构优化**

  - 模块化设计：平稳性分析相关函数独立封装（calculate_cumulative_flow、find_stable_period、linear_fit等），提高代码可维护性。
  - 报告格式优化：平稳性分析采用结构化布局，包含四个分节（平稳期边界信息、线性拟合参数、稳定性指标、滑动窗口分析），每项指标配有详细说明。
  - 跨平台兼容：所有新功能保持Windows/Mac双平台兼容性，支持PyInstaller打包。



### **2025-06-30**

- 新增功能

  - 数据清洗功能：新增Savitzky-Golay滤波器对流量数据进行平滑处理，去除噪点，使曲线更平滑。保留前导零值不进行清洗，确保启动时长计算的准确性。

    > **Savitzky-Golay滤波器原理**：该滤波器通过对数据窗口内的点进行多项式拟合，用拟合值替代中心点，从而实现平滑。相比简单的移动平均，它能更好地保留信号的形状特征（如峰值），同时有效去除高频噪声。本项目使用11点窗口和3阶多项式，在去噪和保真之间达到良好平衡。

  - 温度数据处理：支持读取CSV格式的温度数据文件（CH1-CH3通道），自动进行2秒采样到0.5秒的插值对齐。支持多种编码格式（gbk, gb2312, utf-8, cp1252, latin1）。

    > **温度数据要求**：温度表的起始数据时间点必须与流量原始表的起始点对齐（即两者都从反应开始的0时刻开始记录），结束时间无要求。程序会自动处理不同长度的数据。

  - **流量-温度综合分析图**：新增双Y轴图表，左侧显示平均流量（L/Min），右侧显示温度（°C），直观展示流量与温度的相关性。

- 重要修复

  - **0.9阈值异常分析修正**：修复了反应结束时间的定义——现在正确识别为所有活跃传感器流量都不为0的最后时刻，而非数据采集的结束时刻。这确保了窗口时间（7分钟后到实际结束前2分钟）的准确计算。
  - **时间精度处理**：原始数据表保持0.5秒采样精度，图表横坐标简化为整数秒显示，提高可读性。

- 基准曲线更新

  - 更新了基准曲线数据，新曲线保持相同格式（time,flow），可直接替换使用。主要变化包括启动阶段流量更高（0.17分钟达到3.1L/min），中期流量调整等。



### **2025-06-24**

- **新增功能**

  - 增加了“平均异常分析表_0.9阈值”Sheet：在Excel报告中自动新增一张表，专门用于统计“第7分钟（420秒）起至燃尽前2分钟”区间内，平均流量低于**绝对0.9L/min**的所有异常时段及其持续时间、起止时刻、累积产氧量等信息。
  - 表格字段包括：开始时间（秒）、结束时间（秒）、持续时间（秒）、起点累积流量（升）、终点累积流量（升）。
  
- **窗口区间优化**

  - 异常分析的考察时间段为“点火第7分钟起至燃尽前2分钟”，窗口右端点自动适配每次实验的真实燃尽时间，保证分析科学合理。

- **原有分析表**

  - 其余所有数据分析、性能指标和异常分析表均未变更，继续保留基准曲线相关判据。

- **BUG修复&体验优化**

  - 处理了异常分析时段切分准确性，累计流量计算更为严谨，逻辑更稳健。

  

---
## 项目简介

本项目为化学产氧器测试报告自动生成工具，支持 Windows 和 macOS 双平台。通过读取原始测量表、基准曲线和刻度表，自动生成包含数据分析、关键点提取、性能指标、异常分析和曲线图的完整 Excel 报告，以及对应的图表 PNG。可通过 Python 直接运行，也可使用 PyInstaller 打包为独立可执行文件。

## 目录结构

```
├── reports_input/                    # 输入数据目录
│   ├── 副本氧气流量采集分析表YYYYMMDD.xlsx  # 原始测量表（按前缀匹配）
│   ├── .基准曲线 1.csv                # 基准曲线数据
│   └── .副本4P、2P22M氧烛分层及刻度.xlsx  # 刻度表（4P22M/2P22M）
│
├── reports_output/                   # 输出报告目录（脚本运行自动创建）
│   └── 分析报告_YYYYMMDD_HHMMSS.xlsx    # 生成的完整报告
│
├── generate_reports_cross_platform.py # 跨平台主脚本
├── requirements.txt                  # Python 依赖列表
├── .github/
│   └── workflows/build.yml           # CI/CD 配置（GitHub Actions）
└── README.md                         # 本说明文件
```

## 环境要求

- Python 3.7+
- Windows 10 / macOS 10.15+
- 安装依赖：`pip install -r requirements.txt`

## 使用方法

1. **准备输入数据**，将以下文件放入 `reports_input/` 目录：
   - 原始测量表：
     - 格式：质量流量仪导出的Excel表格（xlsx格式）
     - 文件名以"副本氧气流量采集分析表"开头
     - 数据采样频率：0.5秒
   - 温度数据：
     - 格式：CSV文件，包含CH1、CH2、CH3列
     - 采样频率：2秒
     - 支持多种编码格式
     - **重要**：起始时间点必须与流量表对齐（都从0时刻开始），结束时间无要求

2. 运行脚本：

```bash
python generate_reports_cross_platform.py
```

3. 查看 `reports_output/` 目录，获取带有以下工作表的完整报告：

   - 原始数据

   - 关键点分析

   - 性能指标分析

   - 燃烧定位表

   - 异常分析_1号 … 异常分析_4号

   - 异常分析_平均值

   - 曲线图、产氧-深度曲线

   - 燃烧定位数据

   - 平均异常分析表_0.9阈值（2025-6-24更新加入）

## 打包为可执行文件

使用 PyInstaller 将脚本打包：

```bash
pyinstaller --onefile --name="报告生成器" generate_reports_cross_platform.py
```

打包完成后，可在 `dist/` 目录下获取 `报告生成器.exe`（Windows）或可执行文件（macOS）。

## CI/CD（GitHub Actions）

- Workflow 文件：`.github/workflows/build.yml`
- 每次推送（push）或发布（tag）时，自动安装依赖并执行 PyInstaller 打包，上传产物为 GitHub Release 附件。

## 贡献与许可证

欢迎提交 Issue 和 Pull Request。请遵循项目的编码规范和测试流程。

本项目采用 MIT 许可证，详情参见 LICENSE 文件。